---
title: Construindo Workflows
description: Orquestre múltiplas tools em processos automatizados
icon: GitBranch
---

import Callout from "../../../components/ui/Callout.astro";

Workflows orquestram múltiplas tools em sequência para automatizar processos complexos. Diferentemente de agentes de AI que decidem quais tools chamar, workflows seguem passos determinísticos. Workflows no deco usam o framework Mastra por baixo dos panos, fornecendo um conjunto de padrões composíveis para controle de fluxo.

## Básicos de Workflow

Um workflow encadeia tools e outros workflows em uma sequência determinística. Defina um com `createWorkflow()`, especifique schemas, encadeie passos com `.then()`, e finalize com `.commit()`.

```typescript
import { createWorkflow, createStepFromTool } from "@deco/workers-runtime";

const createCustomerRegistrationWorkflow = (env: Env) => {
  const captureInput = createStepFromTool(createCaptureCustomerInputTool(env));
  const searchCep = createStepFromTool(createCepSearchTool(env));
  const insertCustomer = createStepFromTool(createCustomerInsertTool(env));
  const sendEmail = createStepFromTool(createSendWelcomeEmailTool(env));

  return createWorkflow({
    id: "CUSTOMER_REGISTRATION",
    inputSchema: z.object({
      name: z.string(),
      cpf: z.string(),
      cep: z.string(),
    }),
    outputSchema: z.object({
      customerId: z.number(),
      emailSent: z.boolean(),
    }),
  })
    .then(captureInput)
    .then(searchCep)
    .map(({ captureInputOutput, searchCepOutput }) => ({
      name: captureInputOutput.name,
      cpf: captureInputOutput.cpf,
      city: searchCepOutput.localidade,
      state: searchCepOutput.uf,
    }))
    .then(insertCustomer)
    .then(sendEmail)
    .commit();
};
```

## Padrões de Controle de Fluxo

### Passos Sequenciais (`.then()`)
Encadeie tools uma após a outra:

```typescript
return createWorkflow({...})
  .then(step1)
  .then(step2)
  .then(step3)
  .commit();
```

### Transformação de Dados (`.map()`)
Transforme dados entre passos:

```typescript
.then(cepSearch)
.map(({ cepSearchOutput }) => ({
  address: `${cepSearchOutput.logradouro}, ${cepSearchOutput.localidade}`,
  state: cepSearchOutput.uf,
}))
.then(saveCustomer)
```

### Execução Paralela (`.parallel()`)
Execute múltiplas tools simultaneamente:

```typescript
.parallel([
  createStepFromTool(checkInventory(env)),
  createStepFromTool(validatePayment(env)),
  createStepFromTool(calculateShipping(env)),
])
.then(processOrder)
```

### Lógica Condicional (`.branch()`)
Execute diferentes caminhos baseados em condições:

```typescript
.branch([
  {
    condition: ({ previousOutput }) => previousOutput.type === "premium",
    step: createStepFromTool(premiumProcessing(env)),
  },
  {
    condition: ({ previousOutput }) => previousOutput.type === "standard",
    step: createStepFromTool(standardProcessing(env)),
  },
])
```

### Loops (`.dowhile()` / `.dountil()` / `.foreach()`)
Repita passos baseados em condições ou itere sobre arrays:

```typescript
// Faça polling de uma API até que uma tarefa seja completada
.dountil(
  createStepFromTool(checkTaskStatus(env)),
  ({ checkTaskStatusOutput }) => checkTaskStatusOutput.status === "completed"
)

// Processe uma lista de itens
.foreach(
  createStepFromTool(processItem(env)),
  { 
    concurrency: 3 // Processe 3 itens por vez
  }
)

// Tente novamente em caso de falha
.dowhile(
  createStepFromTool(attemptOperation(env)),
  ({ attemptOperationOutput }) => 
    attemptOperationOutput.failed && attemptOperationOutput.retryCount < 3
)
```

## Testando Workflows

Workflows aparecem como tools com três ações:

1. **Start**: Iniciar execução do workflow
2. **Resume**: Continuar um workflow pausado
3. **Cancel**: Parar execução do workflow

<Callout type="info">
  Workflows executam de forma assíncrona. Eles retornam um ID de execução imediatamente e executam em background.
</Callout>

### Monitorar Execuções de Workflow

1. Vá para seu projeto no [deco CMS](https://admin.decocms.com)
2. Clique em **Workflows** na barra lateral
3. Veja detalhes da execução, incluindo:
   - Progresso passo a passo
   - Input/output para cada passo
   - Tempo de execução
   - Status de sucesso/falha

## Abordagem Híbrida: LLMs em Workflows

Use AI para passos específicos dentro de workflows determinísticos:

```typescript
const createDataProcessingWorkflow = (env: Env) => {
  const extractStructuredData = createStepFromTool(createExtractDataTool(env));
  const validateData = createStepFromTool(createValidateDataTool(env));
  const saveData = createStepFromTool(createSaveDataTool(env));

  return createWorkflow({
    id: "PROCESS_CUSTOMER_MESSAGE",
    inputSchema: z.object({
      message: z.string(), // Mensagem não estruturada do usuário
    }),
    outputSchema: z.object({
      processed: z.boolean(),
    }),
  })
    .then(extractStructuredData) // AI extrai dados estruturados
    .then(validateData)          // Validação determinística
    .then(saveData)             // Salvamento determinístico
    .commit();
};
```

Este padrão lida com input não estruturado (mensagens do usuário) mas processa de forma determinística.