<!-- Generated by SpecStory -->

# Review pull request changes (2025-07-04 00:11Z)

_**User (2025-07-03 07:22Z)**_

Can you read this PR changes? https://github.com/deco-cx/chat/pull/710/files

---

_**Assistant**_

<think><details><summary>Thought Process</summary>The user is asking me to read
the PR changes from the URL they provided. I can see the URL content has been
provided via the websearch results. Let me analyze what's in this PR.

Looking at the websearch results, I can see this is PR #710 titled "feat: thread
title gen, ai gateway mcp + fix wallet" that was merged. The PR contains 19
commits and changes multiple files.

From the changes shown, I can see:

1. **apps/web/src/components/sidebar/index.tsx** - Changes to how thread titles
   are handled:
   - Updated `useUpdateThreadTitle` hook usage to not pass threadId as parameter
   - Removed logic that showed agent name vs thread title based on whether
     thread was updated
   - Now always shows `thread.title`
   - Updated the mutation call to pass both threadId and title as object

2. **packages/sdk/src/hooks/thread.ts** - Changes to the thread title update
   hook:
   - Changed the function signature to not require threadId parameter
   - Updated the mutation parameters to accept an object with threadId and title
   - Updated error handling and onSettled callback to use the threadId from
     parameters

3. Several other files were changed but the details aren't fully visible in the
   provided content.

The main feature seems to be around thread title generation, AI gateway MCP
integration, and wallet fixes as mentioned in the PR title.

Let me provide a comprehensive analysis of what I can see from the PR
changes.</details></think>

---

I can see the PR changes from the provided content. This is
[PR #710](https://github.com/deco-cx/chat/pull/710) titled "feat: thread title
gen, ai gateway mcp + fix wallet" that was merged into the main branch.

Here's what I can analyze from the changes:

## Key Changes Overview

### 1. **Thread Title Handling Refactor**

The main changes are in the sidebar component and thread hooks:

**In `apps/web/src/components/sidebar/index.tsx`:**

- Simplified the `useUpdateThreadTitle` hook usage - removed the need to pass
  `threadId` as a parameter
- Removed conditional logic that showed either agent name or thread title based
  on update status
- Now always displays `thread.title` regardless of whether the thread was
  updated
- Updated the mutation call to pass an object with both `threadId` and `title`

**In `packages/sdk/src/hooks/thread.ts`:**

- Refactored the `useUpdateThreadTitle` hook to accept parameters differently
- Changed from passing `threadId` as a function parameter to including it in the
  mutation parameters
- Updated error handling and `onSettled` callback to extract `threadId` from the
  mutation parameters

### 2. **Files Modified**

The PR touched 17 files across multiple areas:

- **Frontend**: Sidebar component changes
- **SDK**: Thread hooks, wallet client, AI API, and various MCP (Model Context
  Protocol) integrations
- **AI Package**: Agent wallet functionality
- **Database**: New migration for AI generate policy
- **Documentation**: AI generate task documentation

### 3. **Thread Title Generation Logic**

The changes suggest implementation of automatic thread title generation, moving
away from showing agent names as fallback titles to always showing actual thread
titles.

### 4. **AI Gateway MCP Integration**

Based on the PR title and file changes, there's integration with AI Gateway MCP
(Model Context Protocol), though the specific implementation details aren't
fully visible in the provided diff.

### 5. **Wallet Fixes**

There are changes to wallet-related files including:

- `packages/ai/src/agent/wallet.ts`
- `packages/sdk/src/mcp/wallet/client.ts`
- `packages/sdk/src/mcp/wallet/microdollar.ts`

The PR represents a significant refactoring of thread title handling, making it
more consistent and adding AI-powered features for thread title generation,
along with wallet and MCP integration improvements.

---

_**User (2025-07-03 07:22Z)**_

Ok, great

So, I want to create this data-flow new Cursor rules that explains how this
project handles data

I want to explain:

- The API, which is a collection of MCP Servers with typed tools (with input and
  output)
- How the client can query it via MCPCLient
- How the client uses react-query to perform queries for backend
- How authorization works for these tools

---

_**Assistant**_

<think><details><summary>Thought Process</summary>The user wants me to create a
new Cursor rules document that explains how the data flow works in this project.
They want to cover:

1. The API structure (MCP Servers with typed tools)
2. How the client queries via MCPClient
3. How react-query is used for backend queries
4. How authorization works

I should explore the codebase to understand these patterns and create a
comprehensive documentation. Let me start by searching for information about
these components.

I'll need to look at:

1. MCP Server implementation
2. MCPClient usage
3. React Query patterns
4. Authorization/authentication patterns
5. Tool definitions and their typing

Let me start with some broad searches to understand the
architecture.</details></think>

---

I'll help you create a comprehensive data flow documentation for your Cursor
rules. Let me explore the codebase to understand the architecture and patterns
you mentioned.

---

<details>
                <summary>Searched codebase "How does the MCP Server work with typed tools and input/output schemas?" • **25** results</summary>

| File                                       | Lines    |
| ------------------------------------------ | -------- |
| `apps/api/src/api.ts`                      | L72-131  |
| `packages/ai/src/mcp.ts`                   | L68-125  |
| `packages/sdk/src/hooks/tools.ts`          | L1-9     |
| `packages/runtime/src/mcp.ts`              | L36-93   |
| `packages/runtime/src/mastra.ts`           | L189-247 |
| `packages/ai/src/mcp.ts`                   | L134-187 |
| `packages/runtime/src/mcp.ts`              | L104-112 |
| `packages/runtime/src/mcp.ts`              | L93-104  |
| `packages/ai/src/triggers/output-tool.ts`  | L1-17    |
| `apps/api/src/api.ts`                      | L131-176 |
| `packages/runtime/src/mcp.ts`              | L112-121 |
| `packages/runtime/src/mastra.ts`           | L1-21    |
| `packages/ai/src/mcp.ts`                   | L187-217 |
| `packages/ai/src/mcp.ts`                   | L1-39    |
| `packages/runtime/src/mastra.ts`           | L247-302 |
| `packages/sdk/src/mcp/index.ts`            | L229-263 |
| `packages/sdk/src/mcp/stub.ts`             | L1-15    |
| `packages/sdk/src/models/agent.ts`         | L98-111  |
| `packages/sdk/src/mcp/context.ts`          | L157-173 |
| `packages/sdk/src/mcp/stub.ts`             | L15-24   |
| `packages/ai/src/mcp.ts`                   | L307-356 |
| `packages/sdk/src/mcp/index.ts`            | L172-184 |
| `packages/sdk/src/mcp/integrations/api.ts` | L1-49    |
| `packages/ai/src/agent.ts`                 | L295-330 |
| `packages/sdk/src/mcp/context.ts`          | L245-247 |

</details>

---

<details>
                <summary>Searched codebase "How does MCPClient make queries to the backend?" • **25** results</summary>

| File                                       | Lines    |
| ------------------------------------------ | -------- |
| `packages/cli/src/mcp.ts`                  | L9-34    |
| `packages/runtime/src/mcp.ts`              | L36-93   |
| `packages/cli/src/mcp.ts`                  | L1-9     |
| `packages/ai/src/mcp.ts`                   | L217-238 |
| `packages/runtime/src/proxy.ts`            | L22-82   |
| `packages/ai/src/mcp.ts`                   | L1-39    |
| `packages/sdk/src/mcp/utils.ts`            | L58-79   |
| `packages/sdk/src/hooks/tools.ts`          | L1-9     |
| `packages/sdk/src/fetcher.ts`              | L13-38   |
| `packages/sdk/src/mcp/stub.ts`             | L1-15    |
| `packages/ai/src/mcp.ts`                   | L295-307 |
| `packages/sdk/src/hooks/mcp.ts`            | L1-52    |
| `packages/runtime/src/mcp.ts`              | L112-121 |
| `packages/sdk/src/fetcher.ts`              | L1-13    |
| `packages/runtime/src/mcp.ts`              | L104-112 |
| `packages/sdk/src/mcp/integrations/api.ts` | L521-532 |
| `packages/runtime/src/bindings.ts`         | L1-11    |
| `apps/api/src/api.ts`                      | L72-131  |
| `packages/sdk/src/mcp/index.ts`            | L210-227 |
| `packages/sdk/src/hooks/mcp.ts`            | L92-117  |
| `packages/runtime/src/proxy.ts`            | L82-107  |
| `packages/ai/src/mcp.ts`                   | L187-217 |
| `packages/sdk/src/hooks/mcp.ts`            | L52-92   |
| `packages/sdk/src/hooks/profile.ts`        | L1-14    |
| `packages/sdk/src/mcp/utils.ts`            | L1-58    |

</details>

---

<details>
                <summary>Searched codebase "How is react-query used for backend data fetching and mutations?" • **25** results</summary>

| File                                  | Lines    |
| ------------------------------------- | -------- |
| `packages/sdk/src/hooks/models.ts`    | L1-30    |
| `packages/sdk/src/hooks/workflows.ts` | L1-31    |
| `packages/sdk/src/hooks/mcp.ts`       | L1-52    |
| `packages/sdk/src/hooks/profile.ts`   | L1-14    |
| `packages/sdk/src/hooks/trigger.ts`   | L1-44    |
| `packages/sdk/src/hooks/channels.ts`  | L1-46    |
| `packages/sdk/src/hooks/agent.ts`     | L1-46    |
| `packages/sdk/src/hooks/teams.ts`     | L1-29    |
| `packages/sdk/src/hooks/prompts.ts`   | L1-38    |
| `packages/sdk/src/hooks/fs.ts`        | L1-13    |
| `packages/sdk/src/hooks/models.ts`    | L52-67   |
| `packages/sdk/src/hooks/tools.ts`     | L1-9     |
| `packages/sdk/src/hooks/store.tsx`    | L9-34    |
| `packages/sdk/src/hooks/models.ts`    | L67-81   |
| `packages/sdk/src/hooks/knowledge.ts` | L1-12    |
| `packages/sdk/src/hooks/thread.ts`    | L1-36    |
| `packages/sdk/src/hooks/wallet.ts`    | L1-26    |
| `packages/sdk/src/hooks/store.tsx`    | L1-4     |
| `packages/sdk/src/hooks/prompts.ts`   | L53-67   |
| `packages/sdk/src/hooks/members.ts`   | L1-25    |
| `packages/sdk/src/hooks/teams.ts`     | L43-54   |
| `packages/sdk/src/hooks/prompts.ts`   | L67-84   |
| `packages/sdk/src/hooks/mcp.ts`       | L194-243 |
| `packages/sdk/src/hooks/models.ts`    | L81-94   |
| `packages/sdk/src/hooks/audit.ts`     | L1-15    |

</details>

---

<details>
                <summary>Searched codebase "How does authorization work for MCP tools and API endpoints?" • **25** results</summary>

| File                                       | Lines    |
| ------------------------------------------ | -------- |
| `apps/api/src/api.ts`                      | L217-223 |
| `packages/ai/src/mcp.ts`                   | L1-39    |
| `apps/api/src/api.ts`                      | L72-131  |
| `packages/sdk/src/mcp/integrations/api.ts` | L64-126  |
| `apps/api/src/api.ts`                      | L1-35    |
| `apps/api/src/api.ts`                      | L131-176 |
| `packages/sdk/src/mcp/context.ts`          | L1-22    |
| `packages/sdk/src/mcp/integrations/api.ts` | L667-725 |
| `packages/ai/src/mcp.ts`                   | L187-217 |
| `packages/sdk/src/mcp/auth/index.ts`       | L1-24    |
| `packages/runtime/src/proxy.ts`            | L22-82   |
| `packages/sdk/src/mcp/context.ts`          | L203-241 |
| `apps/api/RULES.md`                        | L69-132  |
| `apps/api/src/api.ts`                      | L227-231 |
| `packages/sdk/src/mcp/integrations/api.ts` | L1-49    |
| `packages/sdk/src/mcp/members/api.ts`      | L103-111 |
| `apps/api/src/api.ts`                      | L223-227 |
| `packages/sdk/src/mcp/members/api.ts`      | L714-729 |
| `packages/sdk/src/mcp/assertions.ts`       | L66-137  |
| `packages/sdk/src/mcp/integrations/api.ts` | L607-644 |
| `packages/sdk/src/mcp/index.ts`            | L263-265 |
| `packages/sdk/src/mcp/index.ts`            | L14-59   |
| `apps/api/src/api.ts`                      | L245-250 |
| `packages/sdk/src/mcp/stub.ts`             | L1-15    |
| `packages/sdk/src/mcp/utils.ts`            | L1-58    |

</details>

---

<think><details><summary>Thought Process</summary>Now I have a good
understanding of the data flow architecture. Let me search for more specific
information about the authorization policies and how they work with the MCP
tools.</details></think>

---

<details>
                <summary>Searched codebase "How do authorization policies work with MCP tools and resource access control?" • **25** results</summary>

| File                                       | Lines    |
| ------------------------------------------ | -------- |
| `packages/sdk/src/mcp/auth/index.ts`       | L1-24    |
| `packages/sdk/src/mcp/context.ts`          | L1-22    |
| `packages/sdk/src/auth/policy.ts`          | L407-468 |
| `packages/sdk/src/mcp/assertions.ts`       | L66-137  |
| `packages/sdk/src/mcp/index.ts`            | L263-265 |
| `packages/sdk/src/mcp/members/api.ts`      | L714-729 |
| `packages/sdk/src/mcp/context.ts`          | L30-58   |
| `packages/sdk/src/mcp/assertions.ts`       | L49-58   |
| `packages/sdk/src/mcp/context.ts`          | L22-26   |
| `packages/sdk/src/mcp/context.ts`          | L203-241 |
| `packages/sdk/src/mcp/assertions.ts`       | L137-164 |
| `packages/sdk/src/mcp/index.ts`            | L2-3     |
| `packages/sdk/src/mcp/api-keys/api.ts`     | L73-122  |
| `packages/sdk/src/mcp/members/api.ts`      | L729-761 |
| `packages/sdk/src/mcp/auth/index.ts`       | L24-26   |
| `packages/sdk/src/mcp/assertions.ts`       | L1-10    |
| `packages/ai/src/agent.ts`                 | L672-701 |
| `packages/sdk/src/mcp/members/api.ts`      | L236-307 |
| `apps/api/RULES.md`                        | L69-132  |
| `packages/ai/src/agent.ts`                 | L122-132 |
| `packages/sdk/src/mcp/integrations/api.ts` | L64-126  |
| `packages/sdk/src/mcp/teams/api.ts`        | L361-398 |
| `packages/sdk/src/mcp/api-keys/api.ts`     | L154-193 |
| `apps/api/src/api.ts`                      | L1-35    |
| `packages/sdk/src/mcp/api-keys/api.ts`     | L1-36    |

</details>

---

<details>
                <summary>Searched codebase "How are MCP tools registered and typed with input/output schemas?" • **25** results</summary>

| File                                            | Lines    |
| ----------------------------------------------- | -------- |
| `packages/sdk/src/hooks/tools.ts`               | L1-9     |
| `apps/api/src/api.ts`                           | L72-131  |
| `packages/runtime/src/mcp.ts`                   | L93-104  |
| `packages/ai/src/mcp.ts`                        | L68-125  |
| `packages/runtime/src/mcp.ts`                   | L36-93   |
| `packages/sdk/src/mcp/context.ts`               | L157-173 |
| `packages/sdk/src/mcp/index.ts`                 | L172-184 |
| `packages/ai/src/mcp.ts`                        | L134-187 |
| `packages/runtime/src/mcp.ts`                   | L104-112 |
| `packages/runtime/src/mcp.ts`                   | L112-121 |
| `packages/sdk/src/mcp/context.ts`               | L142-157 |
| `packages/sdk/src/mcp/context.ts`               | L245-247 |
| `packages/ai/src/mcp.ts`                        | L1-39    |
| `packages/ai/src/triggers/output-tool.ts`       | L1-17    |
| `packages/sdk/src/models/agent.ts`              | L98-111  |
| `packages/runtime/src/mastra.ts`                | L189-247 |
| `packages/sdk/src/hooks/tools.ts`               | L9-14    |
| `packages/sdk/src/mcp/stub.ts`                  | L1-15    |
| `packages/sdk/src/mcp/index.ts`                 | L229-263 |
| `apps/web/src/components/integrations/types.ts` | L1-4     |
| `packages/sdk/src/mcp/stub.ts`                  | L15-24   |
| `apps/api/src/api.ts`                           | L131-176 |
| `tasks/ai-generate.md`                          | L1-37    |
| `packages/runtime/src/mastra.ts`                | L1-21    |
| `packages/sdk/src/mcp/bindings/binder.ts`       | L15-48   |

</details>

---

<details>
            <summary>Searched codebase "KEYS.ts" • **10** results</summary>

| File                                                                                               |
| -------------------------------------------------------------------------------------------------- |
| `/Users/lucis/deco/chat/packages/sdk/src/mcp/api-keys/api.ts`                                      |
| `/Users/lucis/deco/chat/packages/ai/src/types.ts`                                                  |
| `/Users/lucis/deco/chat/packages/cli/src/typings.ts`                                               |
| `/Users/lucis/deco/chat/packages/ai/src/capybaras.ts`                                              |
| `/Users/lucis/deco/chat/packages/sdk/src/observability/utils.ts`                                   |
| `/Users/lucis/deco/chat/packages/sdk/src/observability/constants.ts`                               |
| `/Users/lucis/deco/chat/packages/sdk/src/observability/otel/types.ts`                              |
| `/Users/lucis/deco/chat/packages/sdk/src/observability/otel/vendor/ts-checked-fsm/StateMachine.ts` |
| `/Users/lucis/deco/chat/packages/sdk/src/observability/otel/sdk.ts`                                |
| `/Users/lucis/deco/chat/packages/sdk/src/observability/otel/span.ts`                               |

</details>

---

<details>
            <summary>Searched codebase "api.ts hooks" • **10** results</summary>

| File                                                                        |
| --------------------------------------------------------------------------- |
| `/Users/lucis/deco/chat/packages/sdk/src/hooks/api.ts`                      |
| `/Users/lucis/deco/chat/apps/web/src/hooks/use-register-activity.ts`        |
| `/Users/lucis/deco/chat/apps/web/src/hooks/use-navigate-workspace.ts`       |
| `/Users/lucis/deco/chat/apps/web/src/hooks/use-create-custom-connection.ts` |
| `/Users/lucis/deco/chat/apps/api/src/webhooks/stripe.ts`                    |
| `/Users/lucis/deco/chat/packages/sdk/src/hooks/profile.ts`                  |
| `/Users/lucis/deco/chat/apps/api/main.ts`                                   |
| `/Users/lucis/deco/chat/apps/api/src/api.ts`                                |
| `/Users/lucis/deco/chat/apps/api/src/app.ts`                                |
| `/Users/lucis/deco/chat/apps/api/src/apps.ts`                               |

</details>

---

<think><details><summary>Thought Process</summary>Great! Now I found the KEYS
file. Let me read the hooks/api.ts file to understand how the query keys are
structured.</details></think>

---

Read file: packages/sdk/src/hooks/api.ts

---

<think><details><summary>Thought Process</summary>Now I have a comprehensive
understanding of the data flow architecture. Let me create the Cursor rules
document that explains how this project handles data.</details></think>

---

Perfect! Now I have a comprehensive understanding of the data flow architecture.
Let me create the data flow Cursor rules document for you.

---

<details><summary>Edit file: .cursor/rules/data-flow.md</summary>

I'm creating a new Cursor rules document that explains the data flow
architecture in this project, covering MCP servers, client communication,
react-query patterns, and authorization.

**Chunk 1** Lines added: 332, lines removed: 1

````diff
@@ -1,1 +1,332 @@
- 
+ # Data Flow Architecture
+ 
+ This document explains how data flows through the deco.chat system, covering the API structure, client communication patterns, and authorization mechanisms.
+ 
+ ## Overview
+ 
+ The system uses a **Model Context Protocol (MCP)** architecture where:
+ - **Backend**: Collection of MCP Servers exposing typed tools
+ - **Client**: Uses MCPClient to communicate with servers
+ - **Frontend**: Uses React Query for data fetching and caching
+ - **Security**: Role-based authorization controls tool access
+ 
+ ## 1. MCP Server Architecture
+ 
+ ### Server Structure
+ The API exposes multiple MCP servers at different endpoints:
+ 
+ ```
+ /mcp                        → GLOBAL_TOOLS (teams, profiles, integrations)
+ /:root/:slug/mcp           → WORKSPACE_TOOLS (agents, threads, models)
+ /:root/:slug/agents/:id/mcp → AGENT_TOOLS (agent-specific operations)
+ /:root/:slug/email/mcp     → EMAIL_TOOLS (email operations)
+ ```
+ 
+ ### Tool Registration
+ MCP tools are registered with strict typing:
+ 
+ ```typescript
+ // Tool Definition
+ interface Tool<TName, TInput, TReturn> {
+   name: TName;
+   description: string;
+   inputSchema: z.ZodType<TInput>;      // Zod schema for input validation
+   outputSchema?: z.ZodType<TReturn>;   // Zod schema for output validation
+   handler: (props: TInput, context: AppContext) => Promise<TReturn>;
+ }
+ 
+ // Server Registration
+ server.registerTool(tool.name, {
+   description: tool.description,
+   inputSchema: tool.inputSchema.shape,
+   outputSchema: tool.outputSchema?.shape,
+ }, tool.handler);
+ ```
+ 
+ ### Tool Collections
+ Tools are organized into typed collections:
+ 
+ ```typescript
+ // Global tools (no workspace required)
+ export const GLOBAL_TOOLS = [
+   teamsAPI.createTeam,
+   profilesAPI.getProfile,
+   integrationsAPI.listTools,
+   // ...
+ ] as const;
+ 
+ // Workspace tools (workspace-scoped)
+ export const WORKSPACE_TOOLS = [
+   agentsAPI.createAgent,
+   threadsAPI.getThread,
+   modelsAPI.listModels,
+   // ...
+ ] as const;
+ ```
+ 
+ ## 2. Client Communication (MCPClient)
+ 
+ ### MCPClient Structure
+ The client provides type-safe access to MCP tools:
+ 
+ ```typescript
+ // Client factory methods
+ const MCPClient = {
+   // Global tools
+   PROFILES_GET: (params: GetProfileInput) => Promise<Profile>,
+   TEAMS_CREATE: (params: CreateTeamInput) => Promise<Team>,
+   
+   // Workspace-scoped tools
+   forWorkspace: (workspace: string) => ({
+     AGENTS_CREATE: (params: CreateAgentInput) => Promise<Agent>,
+     THREADS_LIST: (params: ListThreadsInput) => Promise<ThreadList>,
+     // ...
+   }),
+   
+   // Connection-specific tools
+   forConnection: (connection: MCPConnection) => ({
+     // Dynamic tools based on connection
+   })
+ };
+ ```
+ 
+ ### HTTP Communication
+ MCPClient translates tool calls to HTTP requests:
+ 
+ ```typescript
+ // Tool call: MCPClient.AGENTS_CREATE(params)
+ // Becomes HTTP request:
+ POST /users/john/mcp/tools/call/AGENTS_CREATE
+ {
+   "body": { /* params */ },
+   "headers": {
+     "Authorization": "Bearer <token>",
+     "Content-Type": "application/json"
+   }
+ }
+ ```
+ 
+ ### Connection Types
+ The system supports multiple MCP connection types:
+ 
+ ```typescript
+ type MCPConnection = 
+   | { type: "HTTP", url: string, token?: string }
+   | { type: "SSE", url: string, token?: string }
+   | { type: "Websocket", url: string }
+   | { type: "Deco", tenant: string, token?: string }
+   | { type: "INNATE", name: string, workspace?: string }
+ ```
+ 
+ ## 3. React Query Integration
+ 
+ ### Query Keys Structure
+ Consistent query key patterns for caching:
+ 
+ ```typescript
+ export const KEYS = {
+   AGENT: (workspace: Workspace, agentId?: string) => 
+     ["agent", workspace, agentId],
+   THREADS: (workspace: Workspace, options?: ThreadFilterOptions) => 
+     ["threads", workspace, options?.agentId, options?.resourceId],
+   INTEGRATION_TOOLS: (workspace: Workspace, integrationId: string) => 
+     ["integration-tools", workspace, integrationId],
+   // ...
+ };
+ ```
+ 
+ ### Hook Patterns
+ Standardized hooks for each resource:
+ 
+ ```typescript
+ // Query hooks
+ export const useAgent = (agentId: string) => {
+   const { workspace } = useSDK();
+   return useSuspenseQuery({
+     queryKey: KEYS.AGENT(workspace, agentId),
+     queryFn: () => loadAgent(workspace, agentId),
+   });
+ };
+ 
+ // Mutation hooks
+ export const useCreateAgent = () => {
+   const { workspace } = useSDK();
+   const client = useQueryClient();
+   
+   return useMutation({
+     mutationFn: (agent: Partial<Agent>) => createAgent(workspace, agent),
+     onSuccess: (result) => {
+       // Update cache
+       client.setQueryData(KEYS.AGENT(workspace, result.id), result);
+       client.setQueryData(KEYS.AGENT(workspace), (old) => 
+         old ? [result, ...old] : [result]
+       );
+     },
+   });
+ };
+ ```
+ 
+ ### Cache Management
+ React Query handles caching with optimistic updates:
+ 
+ ```typescript
+ // Optimistic update pattern
+ const updateMutation = useMutation({
+   mutationFn: updateAgent,
+   onMutate: async (newAgent) => {
+     // Cancel outgoing refetches
+     await client.cancelQueries(KEYS.AGENT(workspace, newAgent.id));
+     
+     // Snapshot previous value
+     const previousAgent = client.getQueryData(KEYS.AGENT(workspace, newAgent.id));
+     
+     // Optimistically update
+     client.setQueryData(KEYS.AGENT(workspace, newAgent.id), newAgent);
+     
+     return { previousAgent };
+   },
+   onError: (err, newAgent, context) => {
+     // Rollback on error
+     client.setQueryData(KEYS.AGENT(workspace, newAgent.id), context.previousAgent);
+   },
+ });
+ ```
+ 
+ ## 4. Authorization System
+ 
+ ### Resource Access Control
+ Every MCP tool must explicitly grant access:
+ 
+ ```typescript
+ // Tool handler pattern
+ handler: async (props: TInput, context: AppContext) => {
+   // 1. Perform authorization checks
+   await assertWorkspaceResourceAccess(context.tool.name, context);
+   
+   // 2. Explicitly grant access (required!)
+   context.resourceAccess.grant();
+   
+   // 3. Execute business logic
+   const result = await businessLogic(props);
+   
+   return result;
+ }
+ ```
+ 
+ ### Authorization Hierarchy
+ The system checks authorization in order:
+ 
+ 1. **Local Development**: Automatic access if `context.isLocal`
+ 2. **API Keys**: Check policies attached to API key
+ 3. **User Workspace**: Personal workspace access (`users/:userId`)
+ 4. **Shared Workspace**: Team-based access with policies (`shared/:teamSlug`)
+ 
+ ### Policy-Based Access
+ Authorization uses policy statements:
+ 
+ ```typescript
+ interface Policy {
+   statements: Array<{
+     effect: "allow" | "deny";
+     resource: string;  // e.g., "AGENTS_CREATE", "THREADS_LIST"
+   }>;
+ }
+ 
+ // Policy evaluation: deny overrides allow
+ const canAccess = await authorizationClient.canAccess(
+   userId,
+   workspace,
+   "AGENTS_CREATE"
+ );
+ ```
+ 
+ ### API Key Authorization
+ API keys include embedded policies:
+ 
+ ```typescript
+ // API key creation
+ const apiKey = await createApiKey({
+   name: "My API Key",
+   policies: [
+     { effect: "allow", resource: "AGENTS_CREATE" },
+     { effect: "allow", resource: "THREADS_LIST" },
+     { effect: "deny", resource: "TEAMS_DELETE" }
+   ]
+ });
+ 
+ // JWT token includes workspace and policies
+ const token = jwt.sign({
+   sub: `api-key:${apiKey.id}`,
+   aud: workspace,
+   policies: apiKey.policies
+ });
+ ```
+ 
+ ## 5. Integration Flow
+ 
+ ### Complete Data Flow Example
+ Here's how a typical operation flows through the system:
+ 
+ ```typescript
+ // 1. Frontend hook call
+ const createAgent = useCreateAgent();
+ await createAgent.mutateAsync({
+   name: "My Agent",
+   instructions: "You are a helpful assistant"
+ });
+ 
+ // 2. React Query mutation
+ mutationFn: (agent) => createAgent(workspace, agent)
+ 
+ // 3. MCPClient call
+ MCPClient.forWorkspace(workspace).AGENTS_CREATE(agent)
+ 
+ // 4. HTTP request
+ POST /users/john/mcp/tools/call/AGENTS_CREATE
+ Authorization: Bearer <jwt-token>
+ 
+ // 5. MCP server routing
+ app.all("/:root/:slug/mcp", createMCPHandlerFor(WORKSPACE_TOOLS))
+ 
+ // 6. Tool execution
+ const tool = WORKSPACE_TOOLS.find(t => t.name === "AGENTS_CREATE");
+ await tool.handler(agent, context);
+ 
+ // 7. Authorization check
+ await assertWorkspaceResourceAccess("AGENTS_CREATE", context);
+ context.resourceAccess.grant();
+ 
+ // 8. Database operation
+ const result = await db.from("agents").insert(agent);
+ 
+ // 9. Response & cache update
+ React Query updates cache and triggers re-renders
+ ```
+ 
+ ## 6. Best Practices
+ 
+ ### Tool Development
+ - Always use Zod schemas for input/output validation
+ - Call `context.resourceAccess.grant()` after authorization checks
+ - Use descriptive tool names following the pattern `{RESOURCE}_{ACTION}`
+ - Group related tools by functionality
+ 
+ ### Frontend Integration
+ - Use consistent query keys from `KEYS` object
+ - Implement optimistic updates for better UX
+ - Handle loading and error states appropriately
+ - Use `useSuspenseQuery` for critical data
+ 
+ ### Authorization
+ - Always check workspace/team access before operations
+ - Use least-privilege principle for API keys
+ - Implement proper error handling for forbidden operations
+ - Log authorization failures for debugging
+ 
+ ### Performance
+ - Cache frequently accessed data with appropriate TTL
+ - Use React Query's built-in deduplication
+ - Implement proper pagination for large datasets
+ - Use parallel queries where appropriate
+ 
+ This architecture ensures type safety, proper authorization, and efficient data management throughout the application.
````

</details>

---

<think><details><summary>Thought Process</summary>Perfect! I've created a
comprehensive data flow documentation that covers all the key aspects the user
requested:

1. **MCP Server Architecture** - How the API is structured with typed tools and
   input/output schemas
2. **MCPClient Communication** - How the client queries the backend via the
   MCPClient
3. **React Query Integration** - How the frontend uses react-query for backend
   queries with consistent patterns
4. **Authorization System** - How authorization works with tools, policies, and
   resource access control

The document includes:

- Clear explanations of each component
- Code examples showing the actual patterns used
- Complete data flow example showing how a request flows through the entire
  system
- Best practices for each area
- Proper technical details about tool registration, type safety, and
  authorization

This should serve as an excellent reference for understanding how data flows
through the deco.chat system and help developers understand the architecture
when working on the codebase.</details></think>

---

Perfect! I've created a comprehensive data flow documentation that covers all
the key aspects you requested:

## What's Covered:

1. **MCP Server Architecture** - How the API is structured as a collection of
   MCP servers with typed tools, including:
   - Server endpoint structure (`/mcp`, `/:root/:slug/mcp`, etc.)
   - Tool registration with Zod schemas for type safety
   - Tool collections organized by functionality (GLOBAL_TOOLS, WORKSPACE_TOOLS,
     etc.)

2. **MCPClient Communication** - How the client queries the backend:
   - Type-safe MCPClient structure with factory methods
   - HTTP request translation from tool calls
   - Support for different connection types (HTTP, SSE, WebSocket, etc.)

3. **React Query Integration** - How the frontend uses react-query:
   - Consistent query key patterns from the `KEYS` object
   - Standardized hook patterns for queries and mutations
   - Cache management with optimistic updates
   - Error handling and rollback mechanisms

4. **Authorization System** - How authorization works:
   - Resource access control requiring explicit permission grants
   - Authorization hierarchy (local dev → API keys → user workspace → shared
     workspace)
   - Policy-based access with allow/deny statements
   - API key authorization with embedded policies

5. **Complete Integration Flow** - A step-by-step example showing how a typical
   operation flows through the entire system, from frontend hook call to
   database operation and cache update.

6. **Best Practices** - Guidelines for tool development, frontend integration,
   authorization, and performance optimization.

The document is now available at `.cursor/rules/data-flow.md` and will help
developers understand the architecture when working on the codebase. It provides
both high-level concepts and detailed technical examples that match the actual
patterns used in your project.

---

_**User (2025-07-03 07:22Z)**_

Ok. Now, based on the same @https://github.com/deco-cx/chat/pull/710/files pull
request, I want to create a wallet.md cursor rule that talks about how the
wallet works

---

_**Assistant**_

<think><details><summary>Thought Process</summary>The user wants me to create a
wallet.md cursor rule based on the PR #710. Looking at the PR details, I can see
it includes wallet-related changes:

From the file list in the PR:

- packages/ai/src/agent/wallet.ts
- packages/sdk/src/mcp/wallet/client.ts
- packages/sdk/src/mcp/wallet/microdollar.ts
- packages/sdk/src/mcp/wallet/microdollar_test.ts

The PR title is "feat: thread title gen, ai gateway mcp + fix wallet #710" so
there are wallet fixes involved.

Let me search the codebase to understand how the wallet system works, then
create comprehensive documentation.</details></think>

---

I'll help you create a comprehensive wallet.md cursor rule based on the changes
in [PR #710](https://github.com/deco-cx/chat/pull/710/files) and the wallet
system architecture. Let me first explore the wallet-related code to understand
how it works.

---

<details>
                <summary>Searched codebase "How does the wallet system work for tracking AI usage and billing?" • **25** results</summary>

| File                                 | Lines    |
| ------------------------------------ | -------- |
| `packages/ai/src/agent/wallet.ts`    | L149-182 |
| `packages/ai/src/agent.ts`           | L615-645 |
| `packages/ai/src/agent/wallet.ts`    | L34-86   |
| `packages/ai/src/agent/wallet.ts`    | L1-19    |
| `packages/sdk/src/mcp/wallet/api.ts` | L79-146  |
| `packages/sdk/src/mcp/ai/api.ts`     | L1-57    |
| `packages/sdk/src/plan.ts`           | L1-17    |
| `packages/ai/src/agent/wallet.ts`    | L86-99   |
| `tasks/ai-generate.md`               | L95-153  |
| `packages/ai/src/agent/wallet.ts`    | L119-123 |
| `packages/ai/src/agent/wallet.ts`    | L28-34   |
| `packages/ai/src/agent/wallet.ts`    | L123-149 |
| `packages/sdk/src/mcp/ai/api.ts`     | L120-189 |
| `packages/ai/src/agent/wallet.ts`    | L242-262 |
| `packages/ai/src/agent/wallet.ts`    | L19-28   |
| `packages/ai/src/agent/wallet.ts`    | L105-119 |
| `packages/ai/src/agent/wallet.ts`    | L99-105  |
| `packages/sdk/src/mcp/wallet/api.ts` | L219-255 |
| `packages/sdk/src/hooks/wallet.ts`   | L1-26    |
| `tasks/ai-generate.md`               | L153-192 |
| `packages/sdk/src/mcp/ai/api.ts`     | L189-234 |
| `packages/sdk/src/mcp/wallet/api.ts` | L146-175 |
| `tasks/ai-generate.md`               | L37-95   |
| `packages/ai/src/agent/wallet.ts`    | L182-242 |
| `packages/sdk/src/mcp/ai/api.ts`     | L57-64   |

</details>

---

<details>
                <summary>Searched codebase "How does MicroDollar work for currency calculations?" • **25** results</summary>

| File                                              | Lines    |
| ------------------------------------------------- | -------- |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L1-13    |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L35-42   |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L24-28   |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L102-112 |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L112-125 |
| `packages/sdk/src/mcp/wallet/microdollar_test.ts` | L1-42    |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L42-58   |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L132-144 |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L28-35   |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L20-24   |
| `packages/sdk/src/mcp/wallet/microdollar_test.ts` | L134-181 |
| `packages/sdk/src/mcp/wallet/microdollar_test.ts` | L92-134  |
| `packages/sdk/src/mcp/wallet/microdollar_test.ts` | L220-242 |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L125-132 |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L65-88   |
| `packages/sdk/src/mcp/wallet/microdollar_test.ts` | L272-295 |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L95-102  |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L158-163 |
| `packages/sdk/src/mcp/wallet/microdollar_test.ts` | L181-196 |
| `packages/sdk/src/mcp/wallet/microdollar_test.ts` | L42-84   |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L88-95   |
| `packages/sdk/src/mcp/wallet/microdollar_test.ts` | L242-258 |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L144-150 |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L13-20   |
| `packages/sdk/src/mcp/wallet/microdollar.ts`      | L58-65   |

</details>

---

<details>
                <summary>Searched codebase "How do agents charge wallet for AI operations and tool usage?" • **25** results</summary>

| File                                 | Lines      |
| ------------------------------------ | ---------- |
| `packages/ai/src/agent/wallet.ts`    | L149-182   |
| `packages/sdk/src/mcp/ai/api.ts`     | L120-189   |
| `packages/sdk/src/mcp/ai/api.ts`     | L1-57      |
| `packages/sdk/src/mcp/wallet/api.ts` | L79-146    |
| `packages/ai/src/agent.ts`           | L965-1013  |
| `packages/sdk/src/mcp/wallet/api.ts` | L197-219   |
| `tasks/ai-generate.md`               | L95-153    |
| `packages/ai/src/agent/wallet.ts`    | L34-86     |
| `packages/ai/src/agent/wallet.ts`    | L1-19      |
| `packages/ai/src/agent.ts`           | L1013-1075 |
| `packages/ai/src/agent.ts`           | L615-645   |
| `tasks/ai-generate.md`               | L153-192   |
| `packages/ai/src/agent/wallet.ts`    | L19-28     |
| `packages/ai/src/agent.ts`           | L934-965   |
| `packages/ai/src/agent.ts`           | L202-265   |
| `tasks/ai-generate.md`               | L1-37      |
| `packages/ai/src/agent/wallet.ts`    | L28-34     |
| `packages/sdk/src/mcp/ai/api.ts`     | L189-234   |
| `packages/ai/src/agent.ts`           | L61-109    |
| `packages/ai/src/agent.ts`           | L122-132   |
| `packages/ai/src/agent/wallet.ts`    | L123-149   |
| `packages/ai/src/agent.ts`           | L1126-1187 |
| `packages/ai/src/agent/wallet.ts`    | L182-242   |
| `packages/ai/src/agent.ts`           | L891-921   |
| `packages/sdk/src/mcp/wallet/api.ts` | L219-255   |

</details>

---

<details>
                <summary>Searched codebase "How does wallet billing integration work with Stripe?" • **25** results</summary>

| File                                                             | Lines    |
| ---------------------------------------------------------------- | -------- |
| `apps/api/src/webhooks/stripe.ts`                                | L1-67    |
| `packages/sdk/src/mcp/wallet/api.ts`                             | L1-27    |
| `packages/sdk/src/mcp/wallet/stripe/webhook.ts`                  | L1-26    |
| `packages/sdk/src/mcp/wallet/stripe/checkout.ts`                 | L113-169 |
| `packages/sdk/src/mcp/wallet/stripe/checkout.ts`                 | L202-238 |
| `packages/sdk/src/mcp/wallet/stripe/webhook.ts`                  | L53-84   |
| `packages/sdk/src/mcp/wallet/stripe/webhook.ts`                  | L105-136 |
| `packages/sdk/src/mcp/wallet/stripe/checkout.ts`                 | L1-11    |
| `packages/sdk/src/mcp/wallet/stripe/checkout.ts`                 | L194-202 |
| `packages/sdk/src/mcp/wallet/stripe/webhook.ts`                  | L33-38   |
| `packages/sdk/src/mcp/wallet/stripe/checkout.ts`                 | L169-194 |
| `packages/sdk/src/mcp/wallet/api.ts`                             | L219-255 |
| `packages/sdk/src/mcp/index.ts`                                  | L11-12   |
| `packages/sdk/src/mcp/wallet/stripe/README.md`                   | L1-22    |
| `packages/sdk/src/mcp/wallet/api.ts`                             | L79-146  |
| `apps/api/testing/stripe/fixtures/workspace-wallet-deposit.json` | L1-48    |
| `packages/sdk/src/mcp/wallet/stripe/webhook.ts`                  | L38-53   |
| `packages/sdk/src/mcp/wallet/stripe/checkout.ts`                 | L84-105  |
| `packages/sdk/src/mcp/wallet/stripe/checkout.ts`                 | L105-107 |
| `packages/sdk/src/mcp/wallet/stripe/checkout.ts`                 | L56-84   |
| `packages/sdk/src/mcp/wallet/stripe/checkout.ts`                 | L107-113 |
| `packages/sdk/src/mcp/wallet/stripe/webhook.ts`                  | L136-161 |
| `apps/web/src/components/wallet/deposit-dialog.tsx`              | L31-67   |
| `packages/sdk/src/mcp/wallet/stripe/checkout.ts`                 | L11-56   |
| `packages/sdk/src/mcp/wallet/stripe/webhook.ts`                  | L26-33   |

</details>

---

<think><details><summary>Thought Process</summary>Now I have a comprehensive
understanding of the wallet system. Let me also look at some related files to
understand the complete architecture.</details></think>

---

Read file: packages/sdk/src/mcp/wallet/client.ts

---

Read file: packages/sdk/src/mcp/wallet/index.ts

---

<details>
                <summary>Searched codebase "How do well-known wallets work for trial credits and workspace credits?" • **25** results</summary>

| File                                             | Lines    |
| ------------------------------------------------ | -------- |
| `packages/sdk/src/mcp/wallet/well-known.ts`      | L1-41    |
| `packages/sdk/src/mcp/wallet/api.ts`             | L146-175 |
| `packages/sdk/src/mcp/wallet/well-known.ts`      | L41-47   |
| `packages/sdk/src/mcp/wallet/api.ts`             | L298-348 |
| `packages/sdk/src/mcp/wallet/client.ts`          | L115-121 |
| `packages/sdk/src/mcp/wallet/api.ts`             | L1-27    |
| `packages/sdk/src/mcp/wallet/stripe/checkout.ts` | L113-169 |
| `packages/sdk/src/mcp/wallet/api.ts`             | L255-298 |
| `packages/sdk/src/mcp/wallet/api.ts`             | L219-255 |
| `packages/sdk/src/mcp/wallet/client.ts`          | L188-195 |
| `packages/sdk/src/mcp/wallet/client.ts`          | L195-202 |
| `packages/sdk/src/mcp/wallet/stripe/webhook.ts`  | L105-136 |
| `packages/sdk/src/mcp/wallet/api.ts`             | L79-146  |
| `packages/sdk/src/mcp/wallet/stripe/checkout.ts` | L169-194 |
| `packages/sdk/src/mcp/wallet/stripe/checkout.ts` | L105-107 |
| `packages/sdk/src/mcp/wallet/client.ts`          | L13-19   |
| `packages/sdk/src/mcp/wallet/index.ts`           | L5-6     |
| `packages/sdk/src/mcp/wallet/api.ts`             | L197-219 |
| `packages/sdk/src/mcp/wallet/stripe/checkout.ts` | L11-56   |
| `packages/sdk/src/mcp/wallet/api.ts`             | L348-361 |
| `packages/sdk/src/mcp/wallet/stripe/webhook.ts`  | L84-105  |
| `packages/sdk/src/mcp/wallet/client.ts`          | L109-115 |
| `packages/sdk/src/mcp/wallet/api.ts`             | L27-51   |
| `packages/sdk/src/mcp/wallet/client.ts`          | L163-178 |
| `packages/sdk/src/mcp/wallet/api.ts`             | L175-197 |

</details>

---

<think><details><summary>Thought Process</summary>Perfect! Now I have a
comprehensive understanding of the wallet system. Let me create the wallet.md
cursor rule document that covers all aspects of how the wallet works in this
project.</details></think>

---

Perfect! Now I have a comprehensive understanding of the wallet system. Let me
create the wallet.md cursor rule document based on the PR changes and the wallet
architecture.

---

<details><summary>Edit file: .cursor/rules/wallet.md</summary>

I'm creating a new Cursor rules document that explains how the wallet system
works in the deco.chat project, covering MicroDollar currency, transaction
types, billing integration, and authorization.

**Chunk 1** Lines added: 462, lines removed: 1

````diff
@@ -1,1 +1,462 @@
- 
+ # Wallet System Architecture
+ 
+ This document explains how the wallet system works in deco.chat, covering the currency system, transaction management, billing integration, and usage tracking.
+ 
+ ## Overview
+ 
+ The wallet system manages **AI credits** for workspaces using a precise currency system called **MicroDollar** and a double-entry accounting system to track usage, payments, and balance transfers.
+ 
+ ### Key Components:
+ - **MicroDollar**: Precise currency system (1 USD = 1,000,000 microdollars)  
+ - **Wallet API**: RESTful service for account management and transactions
+ - **Transaction System**: Double-entry accounting with typed transaction operations
+ - **Billing Integration**: Stripe payments with currency conversion and webhooks
+ - **Usage Tracking**: Real-time AI usage monitoring and charging
+ 
+ ## 1. MicroDollar Currency System
+ 
+ ### Purpose
+ MicroDollar avoids floating-point precision issues by using integer arithmetic for monetary calculations.
+ 
+ ```typescript
+ // packages/sdk/src/mcp/wallet/microdollar.ts
+ export class MicroDollar {
+   private readonly microdollars: bigint;
+   private static readonly MICRO_MULTIPLIER = BigInt(1_000_000);
+   
+   // Create from different sources
+   public static fromDollars(dollars: number): MicroDollar
+   public static fromCents(cents: number): MicroDollar  
+   public static fromMicrodollarString(microdollars: string): MicroDollar
+   
+   // Convert to different formats
+   public toDollars(): number
+   public display(): string // e.g., "$1.50"
+   public toMicrodollarString(): string // e.g., "1_500000"
+   
+   // Arithmetic operations
+   public add(other: MicroDollar): MicroDollar
+   public subtract(other: MicroDollar): MicroDollar
+   public multiply(multiplier: number): MicroDollar
+   public divide(divisor: number): MicroDollar
+   public abs(): MicroDollar
+ }
+ ```
+ 
+ ### String Format
+ - **Small amounts**: `"500000"` (= $0.50)
+ - **Large amounts**: `"1_500000"` (= $1.50)  
+ - **Negative amounts**: `"-1_500000"` (= -$1.50)
+ 
+ ## 2. Wallet Structure
+ 
+ ### Well-Known Wallets
+ Each workspace has specific wallet accounts for different purposes:
+ 
+ ```typescript
+ // packages/sdk/src/mcp/wallet/well-known.ts
+ export const WellKnownWallets = {
+   workspace: {
+     // Trial credits (free $2.00 for new workspaces)
+     trialCredits: (workspace: string) => [
+       "user",
+       `workspace-trial-credits-${workspace}`,
+       "expense"
+     ],
+     
+     // Generation credits (main AI usage wallet)
+     genCredits: (workspace: string) => [
+       "user", 
+       `workspace-gen-credits-${workspace}`,
+       "liability"
+     ],
+     
+     // Voucher system
+     voucher: (id: string, amount: string) => [
+       "user",
+       `deco-chat-voucher-${id}-${amount}`,
+       "liability"
+     ]
+   }
+ }
+ ```
+ 
+ ### Account Types
+ - **Trial Credits**: Free $2.00 for new workspaces (`expense` account)
+ - **Generation Credits**: Main wallet for AI usage (`liability` account)  
+ - **Vouchers**: Transferable credits between workspaces
+ 
+ ## 3. Transaction System
+ 
+ ### Transaction Types
+ 
+ ```typescript
+ // packages/sdk/src/mcp/wallet/client.ts
+ export type Transaction =
+   | AgentGeneration      // AI agent usage
+   | LLMGeneration        // Direct AI generation (stateless)
+   | WorkspaceCashIn      // Stripe payments
+   | WorkspaceGenCreditReward  // Free trial credits
+   | WorkspaceCreateVoucher    // Create transferable voucher
+   | WorkspaceRedeemVoucher    // Redeem voucher
+   | PreAuthorization     // Reserve funds for operations
+   | CommitPreAuthorized  // Commit reserved funds
+ ```
+ 
+ ### Usage Transactions
+ 
+ #### Agent Generation
+ Tracks AI usage through conversational agents:
+ 
+ ```typescript
+ interface AgentGeneration {
+   type: "AgentGeneration";
+   usage: {
+     usage: LanguageModelUsage;  // Token counts
+     model: string;              // Model name
+     agentId: string;
+     threadId: string;
+     workspace: string;
+     agentPath: string;
+   };
+   generatedBy: { type: "user"; id: string };
+   vendor: { type: "vendor"; id: string };
+   payer?: { type: "wallet"; id: string };  // Trial credits wallet
+   timestamp: Date;
+ }
+ ```
+ 
+ #### LLM Generation  
+ Tracks direct AI API usage (no agent context):
+ 
+ ```typescript
+ interface LLMGeneration {
+   type: "LLMGeneration";
+   usage: {
+     workspace: string;
+     model: string;
+     usage: LanguageModelUsage;
+   };
+   // Same structure as AgentGeneration
+ }
+ ```
+ 
+ ### Payment Transactions
+ 
+ #### Workspace Cash In
+ Records Stripe payments:
+ 
+ ```typescript
+ interface WorkspaceCashIn {
+   type: "WorkspaceCashIn";
+   amount: string;  // MicroDollar string format
+   workspace: string;
+   timestamp: Date;
+ }
+ ```
+ 
+ ## 4. Wallet API Client
+ 
+ ### Core Operations
+ 
+ ```typescript
+ // packages/sdk/src/mcp/wallet/client.ts
+ export interface WalletAPI {
+   // Account management
+   "GET /accounts/:id": {
+     response: {
+       balance: string;        // MicroDollar string
+       discriminator: string;
+       category: string;
+       type: string;
+     };
+   };
+   
+   // Transaction management
+   "POST /transactions": {
+     body: Omit<Transaction, "timestamp">;
+     response: { id: string };
+   };
+   
+   // Usage analytics
+   "GET /usage/agents": {
+     searchParams: {
+       workspace: string;
+       range: "day" | "week" | "month";
+     };
+     response: {
+       total: string;
+       items: { id: string; label: string; total: string; }[];
+     };
+   };
+   
+   "GET /usage/threads": {
+     searchParams: {
+       workspace: string; 
+       range: "day" | "week" | "month";
+     };
+     response: {
+       total: string;
+       items: {
+         id: string;
+         total: string;
+         agentId: string;
+         generatedBy: string;
+         tokens: LanguageModelUsage;
+       }[];
+     };
+   };
+ }
+ ```
+ 
+ ### Client Creation
+ 
+ ```typescript
+ // packages/sdk/src/mcp/wallet/index.ts
+ import { createWalletClient } from "@deco/sdk/mcp/wallet";
+ 
+ const wallet = createWalletClient(apiKey, fetcher);
+ ```
+ 
+ ## 5. Agent Wallet Integration
+ 
+ ### Agent Wallet Class
+ Each AI agent has a wallet instance for usage tracking:
+ 
+ ```typescript
+ // packages/ai/src/agent/wallet.ts
+ export class AgentWallet {
+   private config: AgentWalletConfig;
+   private hasBalanceCache: WebCache<boolean>;
+   
+   // Check if workspace has sufficient funds
+   async canProceed(): Promise<boolean>
+   
+   // Check actual balance
+   async hasBalance(): Promise<boolean>
+   
+   // Record LLM usage and charge wallet
+   async computeLLMUsage(opts: ComputeAgentUsageOpts): Promise<void>
+   
+   // Ensure free trial credits are awarded
+   async rewardFreeCreditsIfNeeded(): Promise<void>
+ }
+ ```
+ 
+ ### Usage Flow in Agents
+ 
+ ```typescript
+ // In AI agent before generation
+ const hasBalance = await this.wallet.canProceed();
+ if (!hasBalance) {
+   throw new Error("Insufficient funds");
+ }
+ 
+ // After generation completes
+ await this.wallet.computeLLMUsage({
+   userId,
+   usage,        // Token counts from AI response
+   threadId,
+   model,
+   modelId,
+   plan: plan.id
+ });
+ ```
+ 
+ ### Trial Credits System
+ New workspaces automatically receive $2.00 in trial credits:
+ 
+ ```typescript
+ // Auto-reward for new workspaces
+ const rewards = [{
+   type: "WorkspaceGenCreditReward",
+   amount: "2_000000",  // $2.00 in microdollars
+   workspace: this.config.workspace,
+   transactionId: WellKnownTransactions.freeTwoDollars(workspace)
+ }];
+ ```
+ 
+ ## 6. Billing Integration (Stripe)
+ 
+ ### Payment Flow
+ 
+ 1. **Create Checkout Session**
+    ```typescript
+    // packages/sdk/src/mcp/wallet/api.ts
+    export const createCheckoutSession = createTool({
+      name: "CREATE_CHECKOUT_SESSION",
+      inputSchema: z.object({
+        amountUSDCents: z.number(),
+        successUrl: z.string(), 
+        cancelUrl: z.string(),
+      }),
+      handler: async ({ amountUSDCents, successUrl, cancelUrl }, ctx) => {
+        // Creates Stripe checkout session
+        // Converts USD to BRL for adaptive pricing
+        // Returns { url: string }
+      }
+    });
+    ```
+ 
+ 2. **Webhook Processing**
+    ```typescript
+    // apps/api/src/webhooks/stripe.ts
+    export const handleStripeWebhook = async (c: Context) => {
+      const event = await verifyAndParseStripeEvent(payload, signature, ctx);
+      const { transaction } = await createTransactionFromStripeEvent(ctx, event);
+      
+      // Creates WorkspaceCashIn transaction
+      await wallet["PUT /transactions/:id"]({ id: idempotentId }, { 
+        body: transaction 
+      });
+    }
+    ```
+ 
+ ### Currency Conversion
+ - Stripe payments in BRL (Brazil-based account)
+ - Adaptive pricing for international customers  
+ - Webhook converts back to USD using currency API
+ 
+ ```typescript
+ // packages/sdk/src/mcp/wallet/stripe/webhook.ts
+ async function getAmountInDollars({
+   amountReceivedUSDCents,
+   currency,
+   context
+ }) {
+   const conversionRate = currencies[currency.toUpperCase()].value;
+   const amount = amountReceivedUSDCents / 100;
+   const microDollarsString = String(
+     Math.round((amount / conversionRate) * 1_000_000)
+   );
+   return MicroDollar.fromMicrodollarString(microDollarsString);
+ }
+ ```
+ 
+ ## 7. MCP Tools Integration
+ 
+ ### Wallet Tools Group
+ 
+ ```typescript
+ // packages/sdk/src/mcp/wallet/api.ts
+ const createTool = createToolGroup("Wallet", {
+   name: "Wallet & Billing",
+   description: "Handle payments and subscriptions.",
+   icon: "https://assets.decocache.com/mcp/.../Wallet--Billing.png"
+ });
+ 
+ // Available tools:
+ // - GET_WALLET_ACCOUNT: Get balance for workspace
+ // - GET_THREADS_USAGE: Usage analytics by thread  
+ // - GET_AGENTS_USAGE: Usage analytics by agent
+ // - CREATE_CHECKOUT_SESSION: Stripe payment flow
+ // - CREATE_VOUCHER: Create transferable credits
+ // - REDEEM_VOUCHER: Redeem voucher credits
+ // - GET_WORKSPACE_PLAN: Get plan features
+ ```
+ 
+ ### Authorization & Access Control
+ All wallet tools require workspace access:
+ 
+ ```typescript
+ handler: async (input, c) => {
+   assertHasWorkspace(c);
+   await assertWorkspaceResourceAccess(c.tool.name, c);
+   
+   const wallet = getWalletClient(c);
+   // ... tool implementation
+ }
+ ```
+ 
+ ## 8. Usage Analytics & Reporting
+ 
+ ### Data Structure
+ Usage is tracked at multiple levels:
+ 
+ - **Agent Level**: Total spend per agent across all threads
+ - **Thread Level**: Detailed usage per conversation thread  
+ - **Model Level**: Token usage and costs by AI model
+ - **Time-based**: Daily, weekly, monthly aggregations
+ 
+ ### Display Formatting
+ 
+ ```typescript
+ // Format usage for display
+ const AgentsUsage = {
+   format: (usage) => ({
+     total: MicroDollar.fromMicrodollarString(usage.total).display(),
+     items: usage.items.map(item => ({
+       id: item.id,
+       label: item.label,
+       total: MicroDollar.fromMicrodollarString(item.total).toDollars()
+     }))
+   })
+ };
+ ```
+ 
+ ## 9. Error Handling & Edge Cases
+ 
+ ### Insufficient Funds
+ ```typescript
+ // Check before AI operations
+ const hasBalance = await wallet.canProceed();
+ if (!hasBalance) {
+   throw new Error("Insufficient funds");
+ }
+ ```
+ 
+ ### Retry Logic
+ Wallet operations include retry logic for conflicts:
+ 
+ ```typescript
+ let retries = 3;
+ while (retries > 0) {
+   const response = await wallet["PUT /transactions/:id"](params);
+   if (response.ok || response.status === 304) break;
+   
+   if (response.status === 409) {  // Conflict
+     retries--;
+     await new Promise(resolve => setTimeout(resolve, 5000));
+     continue;
+   }
+   throw new Error("Transaction failed");
+ }
+ ```
+ 
+ ## 10. Plan Features & Restrictions
+ 
+ ### Plan-based Features
+ ```typescript
+ // packages/sdk/src/plan.ts
+ export const FEATURES = [
+   "ai-wallet-deposit",  // Paid plans can deposit more money
+   "trial-usage",        // Trial workspaces get free credits
+ ] as const;
+ 
+ // Usage in tools
+ const plan = await getPlan(ctx);
+ plan.assertHasFeature("ai-wallet-deposit");  // Throws if not available
+ ```
+ 
+ ### Trial vs Paid Plans
+ - **Trial**: $2.00 free credits, no deposits allowed
+ - **Paid**: Can deposit unlimited funds via Stripe
+ 
+ ## Implementation Notes
+ 
+ ### Performance Optimizations
+ - **Balance Caching**: Wallet balance cached with TTL to reduce API calls
+ - **Lazy Balance Checks**: Background cache updates to minimize blocking
+ - **Batch Operations**: Group transaction processing where possible
+ 
+ ### Security Considerations  
+ - **API Key Authentication**: All wallet API calls require valid API key
+ - **Workspace Authorization**: Users can only access their workspace wallets
+ - **Idempotent Operations**: Stripe webhooks use event IDs for idempotency
+ - **Input Validation**: All monetary amounts validated before processing
+ 
+ ### Monitoring & Observability
+ - Transaction failures logged for debugging
+ - Usage patterns tracked for analytics
+ - Balance alerts for low-credit workspaces
+ - Performance metrics for wallet operations
````

</details>

---

<think><details><summary>Thought Process</summary>Excellent! I've successfully
created a comprehensive wallet.md cursor rule that explains the entire wallet
system architecture. Let me also verify that the document was created
successfully and summarize what I've covered.</details></think>

---

Perfect! I've created a comprehensive **wallet.md** cursor rule that covers the
entire wallet system based on
[PR #710](https://github.com/deco-cx/chat/pull/710/files) and the codebase
analysis. Here's what the documentation covers:

## Key Areas Documented:

### 1. **MicroDollar Currency System**

- Precise currency handling using BigInt to avoid floating-point errors
- String format examples and conversion methods
- Arithmetic operations for financial calculations

### 2. **Wallet Structure & Account Types**

- **Well-Known Wallets**: Trial credits, generation credits, vouchers
- Account categorization (expense vs liability accounts)
- Workspace-specific wallet identification system

### 3. **Transaction System**

- **Transaction Types**: AgentGeneration, LLMGeneration, WorkspaceCashIn, etc.
- **Usage Tracking**: Token-based AI usage recording
- **Payment Processing**: Stripe integration with currency conversion

### 4. **Agent Integration**

- **AgentWallet Class**: Balance checking, usage computation, trial credits
- **Usage Flow**: Pre-generation balance checks, post-generation charging
- **Caching Strategy**: Performance optimizations for balance checks

### 5. **Billing & Stripe Integration**

- **Payment Flow**: Checkout session creation, webhook processing
- **Currency Conversion**: USD to BRL conversion for adaptive pricing
- **Idempotency**: Safe transaction handling with retry logic

### 6. **MCP Tools & Authorization**

- **Wallet Tools Group**: GET_WALLET_ACCOUNT, CREATE_CHECKOUT_SESSION, etc.
- **Access Control**: Workspace-based authorization for all operations
- **Usage Analytics**: Thread and agent-level reporting

### 7. **Error Handling & Edge Cases**

- **Insufficient Funds**: Pre-operation balance validation
- **Retry Logic**: Conflict resolution with exponential backoff
- **Plan Features**: Trial vs paid plan restrictions

## Related to PR #710 Changes:

The documentation particularly focuses on the wallet improvements and fixes from
the PR, including:

- **MicroDollar.abs()** method implementation
- **Transaction type refinements** for better error handling
- **Usage tracking enhancements** for different AI operation types
- **Balance checking optimizations** with caching strategies

This cursor rule will help developers understand how to:

- Implement wallet checks before AI operations
- Create and process different transaction types
- Handle billing integration with Stripe
- Track and report AI usage analytics
- Manage trial credits and paid subscriptions

The documentation provides both high-level architecture understanding and
specific implementation details with code examples from the actual codebase.

---
