# AI Integration Tool Wallet Debit Research

## Current Agent Wallet Debit Implementation Analysis

After analyzing the codebase, I found how wallet debiting is currently implemented for agent AI consumption. Here are the key findings:

### 1. Current Agent Wallet Debit Pattern

**Location**: `packages/ai/src/agent/wallet.ts`

**Method**: `computeLLMUsage()`

**Transaction Structure**:
```typescript
function createAgentUsageTransaction({
  usage,
  threadId,
  model,
  modelId,
  userId,
  agentId,
  agentPath,
  workspace,
  plan,
}: CreateUsageTransactionOpts): Transaction {
  const usageData = {
    model,
    modelId,
    agentId,
    threadId,
    workspace,
    agentPath,
  };
  const vendor = {
    type: "vendor" as const,
    id: workspace,
  };
  const generatedBy = {
    type: "user" as const,
    id: userId || "unknown",
  };

  return {
    type: "AgentGeneration" as const,
    usage: {
      usage,
      ...usageData,
    },
    generatedBy,
    vendor,
    payer: plan === "trial"
      ? {
        type: "wallet" as const,
        id: WellKnownWallets.build(
          ...WellKnownWallets.workspace.trialCredits(workspace),
        ),
      }
      : undefined,
    metadata: {
      ...usageData,
      ...usage,
    },
    timestamp: new Date(),
  };
}
```

**Key Components**:
- **Transaction Type**: `"AgentGeneration"`
- **Usage Event**: `AgentUsageEvent` with model, usage tokens, agentId, threadId, workspace, agentPath
- **Vendor**: Workspace ID
- **Generated By**: User ID
- **Payer**: Trial credits wallet for trial plans, undefined for paid plans
- **Wallet Client Call**: `this.client["POST /transactions"]({}, { body: operation })`

### 2. Transaction Types in Wallet Client

**Location**: `packages/sdk/src/mcp/wallet/client.ts`

**Current Transaction Types**:
```typescript
export type Transaction =
  | Generation           // Uses AppUsageEvent
  | AgentGeneration      // Uses AgentUsageEvent  
  | CashIn
  | WorkspaceCashIn
  | CashOut
  | Wiretransfer
  | GenCreditsReward
  | WorkspaceGenCreditReward
  | WorkspaceCreateVoucher
  | WorkspaceRedeemVoucher
  | PreAuthorization
  | CommitPreAuthorized;
```

**Agent vs App Usage Events**:
```typescript
export interface AgentUsageEvent {
  model: string;
  usage: TextModelUsage;
  agentId: string;
  agentPath: string;
  threadId: string;
  workspace: string;
}

export interface AppUsageEvent {
  model: string;
  type: "text" | "image" | "video" | "audio" | "object3d";
  appId: string;
  usage: TextModelUsage | ImageModelUsage | VideoModelUsage | AudioModelUsage;
}
```

## Issues Found with AI Integration Implementation

### ❌ Problem: Missing AI Integration Transaction Type

**Issue**: I could not find the AI integration tools (`AI_GENERATE_TEXT`, `AI_GENERATE_OBJECT`) or the `"AIIntegrationGeneration"` transaction type mentioned in your message.

**Search Results**: 
- No `AI_GENERATE_TEXT` or `AI_GENERATE_OBJECT` tools found
- No `"AIIntegrationGeneration"` transaction type in wallet client
- No `packages/sdk/src/mcp/ai-integration/api.ts` file found

## Recommendations for Proper AI Integration Wallet Debit Implementation

### 1. Add New Transaction Type to Wallet Client

**File**: `packages/sdk/src/mcp/wallet/client.ts`

Add new transaction type and usage event:

```typescript
export interface AIIntegrationUsageEvent {
  model: string;
  usage: TextModelUsage;
  toolId: string;
  workspace: string;
  // Optional: threadId for tracking context
  threadId?: string;
}

export interface AIIntegrationGeneration extends BaseGeneration {
  type: "AIIntegrationGeneration";
  usage: AIIntegrationUsageEvent;
}

// Update the Transaction union type
export type Transaction =
  | Generation
  | AgentGeneration
  | AIIntegrationGeneration  // <-- Add this
  | CashIn
  | WorkspaceCashIn
  // ... rest of types
```

### 2. Create AI Integration Wallet Helper

**File**: `packages/sdk/src/mcp/ai-integration/wallet.ts`

```typescript
import type { ClientOf } from "@deco/sdk/http";
import type { Workspace } from "@deco/sdk/path";
import {
  MicroDollar,
  type Transaction,
  type WalletAPI,
  WellKnownWallets,
} from "@deco/sdk/mcp/wallet";
import type { LanguageModelUsage } from "ai";
import type { Plan } from "@deco/sdk";

export interface AIIntegrationWalletConfig {
  wallet: ClientOf<WalletAPI>;
  workspace: Workspace;
}

export interface ComputeAIIntegrationUsageOpts {
  userId?: string;
  usage: LanguageModelUsage;
  toolId: string;
  model: string;
  modelId: string;
  plan: Plan;
  threadId?: string;
}

function createAIIntegrationUsageTransaction({
  usage,
  toolId,
  model,
  modelId,
  userId,
  workspace,
  plan,
  threadId,
}: ComputeAIIntegrationUsageOpts & { workspace: string }): Transaction {
  const usageData = {
    model,
    modelId,
    toolId,
    workspace,
    ...(threadId && { threadId }),
  };
  
  const vendor = {
    type: "vendor" as const,
    id: workspace,
  };
  
  const generatedBy = {
    type: "user" as const,
    id: userId || "unknown",
  };

  return {
    type: "AIIntegrationGeneration" as const,
    usage: {
      usage,
      ...usageData,
    },
    generatedBy,
    vendor,
    payer: plan === "trial"
      ? {
        type: "wallet" as const,
        id: WellKnownWallets.build(
          ...WellKnownWallets.workspace.trialCredits(workspace),
        ),
      }
      : undefined,
    metadata: {
      ...usageData,
      ...usage,
    },
    timestamp: new Date(),
  };
}

export class AIIntegrationWallet {
  constructor(private config: AIIntegrationWalletConfig) {}

  get client() {
    return this.config.wallet;
  }

  async computeAIIntegrationUsage(opts: ComputeAIIntegrationUsageOpts) {
    const operation = createAIIntegrationUsageTransaction({
      ...opts,
      workspace: this.config.workspace,
    });

    const response = await this.client["POST /transactions"]({}, {
      body: operation,
    });

    if (!response.ok) {
      console.error("Failed to debit AI integration usage", response);
      throw new Error("Failed to debit wallet for AI integration usage");
    }

    return response;
  }

  async hasBalance() {
    const walletId = WellKnownWallets.build(
      ...WellKnownWallets.workspace.genCredits(this.config.workspace),
    );
    
    const response = await this.client["GET /accounts/:id"]({
      id: encodeURIComponent(walletId),
    });

    if (response.status === 404) {
      return false;
    }

    if (!response.ok) {
      console.error("Failed to check balance", response);
      return true;
    }

    const data = await response.json();
    const balance = MicroDollar.fromMicrodollarString(data.balance);
    return !balance.isNegative() && !balance.isZero();
  }
}
```

### 3. AI Integration Tools Implementation Pattern

**File**: `packages/sdk/src/mcp/ai-integration/api.ts`

```typescript
import { createTool } from "../context.ts";
import { generateText, generateObject } from "ai";
import { AIIntegrationWallet } from "./wallet.ts";
import { createWalletClient } from "../wallet/index.ts";
import { assertHasWorkspace } from "../assertions.ts";

export const AI_GENERATE_TEXT = createTool({
  name: "AI_GENERATE_TEXT",
  description: "Generate text using AI models",
  inputSchema: z.object({
    messages: z.array(MessageSchema),
    model: z.string().optional().default("anthropic:claude-sonnet-4"),
    // ... other Vercel AI SDK parameters
  }),
  handler: async (input, ctx) => {
    assertHasWorkspace(ctx);
    
    // Check balance first
    const wallet = new AIIntegrationWallet({
      wallet: createWalletClient(ctx.env.WALLET_API_KEY),
      workspace: ctx.workspace.value,
    });
    
    const hasBalance = await wallet.hasBalance();
    if (!hasBalance) {
      throw new Error("Insufficient funds");
    }

    // Get user plan
    const plan = await ctx.mcpClient.GET_WORKSPACE_PLAN({});
    
    // Call AI model (following Vercel AI SDK signature)
    const result = await generateText({
      ...input,
      // Configure LLM instance based on model
    });

    // Debit wallet using same pattern as agents
    await wallet.computeAIIntegrationUsage({
      userId: ctx.user.id,
      usage: result.usage,
      toolId: "AI_GENERATE_TEXT",
      model: input.model,
      modelId: input.model, // or resolve to actual model ID
      plan: plan.id,
      threadId: ctx.threadId, // if available
    });

    return result;
  },
});

export const AI_GENERATE_OBJECT = createTool({
  name: "AI_GENERATE_OBJECT", 
  description: "Generate structured objects using AI models",
  inputSchema: z.object({
    messages: z.array(MessageSchema),
    schema: z.object({}).passthrough(),
    model: z.string().optional().default("anthropic:claude-sonnet-4"),
    // ... other Vercel AI SDK parameters
  }),
  handler: async (input, ctx) => {
    // Similar implementation to AI_GENERATE_TEXT but using generateObject
    // ... same wallet checking and debiting pattern
  },
});
```

## Summary

**✅ Current Agent Implementation**: Uses `"AgentGeneration"` transaction type with `AgentUsageEvent`

**❌ AI Integration Issue**: The mentioned AI integration tools and `"AIIntegrationGeneration"` transaction type don't exist yet

**✅ Recommended Solution**: 
1. Add `"AIIntegrationGeneration"` transaction type to wallet client
2. Create dedicated AI integration wallet helper class
3. Use the same wallet debit pattern as agents: check balance → call AI → debit wallet
4. Follow exact same transaction structure but with AI integration specific usage event

The key is ensuring the AI integration tools use the **exact same wallet debit flow** as the current agent implementation, just with a different transaction type and usage event structure appropriate for tool calls rather than agent conversations.